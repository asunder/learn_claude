{% extends "base.html" %}

{% block title %}Terraform Generator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-layer-group"></i> Terraform Code Generator</h4>
                <p class="mb-0">Generate Infrastructure as Code for AWS, Azure, and GCP</p>
            </div>
            <div class="card-body">
                <form id="terraformForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="provider" class="form-label">Cloud Provider</label>
                            <select class="form-select" id="provider" name="provider" required>
                                <option value="">Select Provider</option>
                                <option value="aws">AWS</option>
                                <option value="azure">Azure</option>
                                <option value="gcp">Google Cloud Platform</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="resource_type" class="form-label">Resource Type</label>
                            <select class="form-select" id="resource_type" name="resource_type" required>
                                <option value="">Select Resource</option>
                                <!-- Options will be populated based on provider -->
                            </select>
                        </div>
                    </div>
                    
                    <div id="configSection" style="display: none;">
                        <h6>Configuration</h6>
                        <div id="configFields">
                            <!-- Dynamic fields will be added here -->
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-code"></i> Generate Terraform
                    </button>
                </form>
            </div>
        </div>
        
        <div id="loadingDiv" class="text-center mt-4" style="display: none;">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Generating...</span>
            </div>
            <p class="mt-2">Generating Terraform code...</p>
        </div>
        
        <div id="resultsDiv" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-file-code"></i> Generated Terraform Code</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                <div class="card-body">
                    <pre><code id="generatedCode" class="language-hcl"></code></pre>
                </div>
            </div>
        </div>
        
        <div id="errorDiv" class="alert alert-danger mt-4" style="display: none;">
            <h6><i class="fas fa-exclamation-triangle"></i> Error</h6>
            <p id="errorMessage"></p>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h5>Quick Templates</h5>
                <p>Click to load common configurations:</p>
                <div class="row">
                    <div class="col-md-4">
                        <button class="btn btn-outline-warning btn-sm mb-2 quick-template" 
                                data-provider="aws" data-resource="ec2" data-config='{"name":"web-server","instance_type":"t3.micro","environment":"production"}'>
                            AWS Web Server
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary btn-sm mb-2 quick-template"
                                data-provider="azure" data-resource="vm" data-config='{"name":"web-vm","location":"East US","vm_size":"Standard_B1s"}'>
                            Azure VM
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-danger btn-sm mb-2 quick-template"
                                data-provider="gcp" data-resource="compute" data-config='{"name":"web-instance","machine_type":"e2-micro","zone":"us-central1-a"}'>
                            GCP Instance
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const resourceTypes = {
    aws: [
        { value: 'ec2', text: 'EC2 Instance' }
    ],
    azure: [
        { value: 'vm', text: 'Virtual Machine' }
    ],
    gcp: [
        { value: 'compute', text: 'Compute Engine' }
    ]
};

const configFields = {
    aws: {
        ec2: [
            { name: 'name', label: 'Instance Name', type: 'text', placeholder: 'web-server' },
            { name: 'ami', label: 'AMI ID', type: 'text', placeholder: 'ami-0abcdef1234567890' },
            { name: 'instance_type', label: 'Instance Type', type: 'text', placeholder: 't3.micro' },
            { name: 'key_name', label: 'Key Pair Name', type: 'text', placeholder: 'my-key-pair' },
            { name: 'environment', label: 'Environment', type: 'text', placeholder: 'production' }
        ]
    },
    azure: {
        vm: [
            { name: 'name', label: 'VM Name', type: 'text', placeholder: 'web-vm' },
            { name: 'location', label: 'Location', type: 'text', placeholder: 'East US' },
            { name: 'vm_size', label: 'VM Size', type: 'text', placeholder: 'Standard_B1s' },
            { name: 'admin_username', label: 'Admin Username', type: 'text', placeholder: 'adminuser' },
            { name: 'environment', label: 'Environment', type: 'text', placeholder: 'production' }
        ]
    },
    gcp: {
        compute: [
            { name: 'name', label: 'Instance Name', type: 'text', placeholder: 'web-instance' },
            { name: 'project_id', label: 'Project ID', type: 'text', placeholder: 'my-project-123' },
            { name: 'zone', label: 'Zone', type: 'text', placeholder: 'us-central1-a' },
            { name: 'machine_type', label: 'Machine Type', type: 'text', placeholder: 'e2-micro' },
            { name: 'environment', label: 'Environment', type: 'text', placeholder: 'production' }
        ]
    }
};

document.addEventListener('DOMContentLoaded', function() {
    const providerSelect = document.getElementById('provider');
    const resourceSelect = document.getElementById('resource_type');
    const configSection = document.getElementById('configSection');
    const configFields = document.getElementById('configFields');
    const form = document.getElementById('terraformForm');
    
    providerSelect.addEventListener('change', function() {
        const provider = this.value;
        resourceSelect.innerHTML = '<option value="">Select Resource</option>';
        
        if (provider && resourceTypes[provider]) {
            resourceTypes[provider].forEach(resource => {
                const option = document.createElement('option');
                option.value = resource.value;
                option.textContent = resource.text;
                resourceSelect.appendChild(option);
            });
        }
        
        configSection.style.display = 'none';
    });
    
    resourceSelect.addEventListener('change', function() {
        const provider = providerSelect.value;
        const resource = this.value;
        
        if (provider && resource && configFields[provider] && configFields[provider][resource]) {
            generateConfigFields(provider, resource);
            configSection.style.display = 'block';
        } else {
            configSection.style.display = 'none';
        }
    });
    
    // Quick templates
    document.querySelectorAll('.quick-template').forEach(btn => {
        btn.addEventListener('click', function() {
            const provider = this.dataset.provider;
            const resource = this.dataset.resource;
            const config = JSON.parse(this.dataset.config);
            
            providerSelect.value = provider;
            providerSelect.dispatchEvent(new Event('change'));
            
            setTimeout(() => {
                resourceSelect.value = resource;
                resourceSelect.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    // Fill in config values
                    Object.keys(config).forEach(key => {
                        const field = document.getElementById(key);
                        if (field) field.value = config[key];
                    });
                }, 100);
            }, 100);
        });
    });
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        generateTerraform();
    });
});

function generateConfigFields(provider, resource) {
    const fieldsContainer = document.getElementById('configFields');
    fieldsContainer.innerHTML = '';
    
    const fields = configFields[provider][resource];
    fields.forEach(field => {
        const div = document.createElement('div');
        div.className = 'mb-3';
        div.innerHTML = `
            <label for="${field.name}" class="form-label">${field.label}</label>
            <input type="${field.type}" class="form-control" id="${field.name}" name="${field.name}" 
                   placeholder="${field.placeholder}">
        `;
        fieldsContainer.appendChild(div);
    });
}

function generateTerraform() {
    const formData = new FormData(document.getElementById('terraformForm'));
    const loadingDiv = document.getElementById('loadingDiv');
    const resultsDiv = document.getElementById('resultsDiv');
    const errorDiv = document.getElementById('errorDiv');
    
    loadingDiv.style.display = 'block';
    resultsDiv.style.display = 'none';
    errorDiv.style.display = 'none';
    
    fetch('/generate_terraform', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        loadingDiv.style.display = 'none';
        
        if (data.error) {
            document.getElementById('errorMessage').textContent = data.error;
            errorDiv.style.display = 'block';
        } else {
            document.getElementById('generatedCode').textContent = data.code;
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
            resultsDiv.style.display = 'block';
        }
    })
    .catch(error => {
        loadingDiv.style.display = 'none';
        document.getElementById('errorMessage').textContent = 'Request failed: ' + error.message;
        errorDiv.style.display = 'block';
    });
}

function copyToClipboard() {
    const code = document.getElementById('generatedCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        // Show success message
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
            btn.innerHTML = originalText;
        }, 2000);
    });
}
</script>
{% endblock %}